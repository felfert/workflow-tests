name: UT for validate-versions

on:
  workflow_dispatch:

jobs:

  test:
    runs-on: ubuntu-latest
    continue-on-error: true
    name: ${{ matrix.job.name }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - name: No tomls
            refname: '0.2.4'
            reftype: 'tag'
            expected: 'success'
          - name: Nonexisting toml
            refname: '0.2.4'
            reftype: 'tag'
            tomls: nonexisting.toml
            expected: 'failure'
          - name: Normal tag
            refname: '0.2.4'
            reftype: 'tag'
            tomls: |
              Cargo.toml
              cherryrgb/Cargo.toml
            expected: 'success'
          - name: Wrong version in toml
            refname: '0.2.4'
            reftype: 'tag'
            tomls: |
              Cargo-wrongversion.toml
              cherryrgb/Cargo.toml
            expected: 'failure'
          - name: Bad tag
            refname: 'foobar'
            reftype: 'tag'
            tomls: |
              Cargo.toml
              cherryrgb/Cargo.toml
            expected: 'xfailure'
          - name: Normal branch
            refname: 'master'
            reftype: 'branch'
            tomls: |
              Cargo.toml
              cherryrgb/Cargo.toml
            expected: 'success'
    steps:
      - uses: actions/checkout@v3
      - id: test
        uses: ./.github/actions/validate-versions
        with:
          refname: ${{ matrix.job.refname }}
          reftype: ${{ matrix.job.reftype }}
          tomls: ${{ matrix.job.tomls }}
      - if: always() && !cancelled()
        name: Fetch result cache
        uses: actions/cache@v3
        with:
          path: results
        key: ${{ github.workflow }}_testresults
      - if: always() && !cancelled()
        run: |
          mkdir -p results
          if ${{ steps.test.outcome != matrix.job.expected }} ; then
            touch "results/$(echo ${{ matrix.job.name }} | tr " " _).failed"
          fi
      - if: always() && !cancelled()
        name: Update result cache
        uses: actions/cache@v3
        with:
          path: results
        key: ${{ github.workflow }}_testresults

  main:
    needs: [test]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v3
        with:
        path: results
        key: ${{ github.workflow }}_testresults
    steps:
      - run: ls results/
